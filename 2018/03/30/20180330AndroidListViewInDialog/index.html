<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>由Dialog里面嵌套ListView之后的高度自适应引起的ListView性能优化 | 独ǒ无②&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="先说ListView给高的正确做法.android:layout_height属性：  必须将ListView的布局高度属性设置为非“wrap_content”（可以是“match_parent /  fill_parent  /  400dp等绝对数值”）">
<meta name="keywords" content="Android,性能优化,ListView">
<meta property="og:type" content="article">
<meta property="og:title" content="由Dialog里面嵌套ListView之后的高度自适应引起的ListView性能优化">
<meta property="og:url" content="https://www.shenzhenwei.cn/2018/03/30/20180330AndroidListViewInDialog/index.html">
<meta property="og:site_name" content="独ǒ无②&#39;s blog">
<meta property="og:description" content="先说ListView给高的正确做法.android:layout_height属性：  必须将ListView的布局高度属性设置为非“wrap_content”（可以是“match_parent /  fill_parent  /  400dp等绝对数值”）">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://dn-coding-net-production-pp.qbox.me/db684e69-16b3-41af-bd42-fd92506790ce.png">
<meta property="og:image" content="https://dn-coding-net-production-pp.qbox.me/917604eb-c83f-468f-a509-e1adcea53472.png">
<meta property="og:image" content="https://dn-coding-net-production-pp.qbox.me/19b0ceaa-ffd6-44d6-80a1-3d4034e5ead5.png">
<meta property="og:image" content="https://ws4.sinaimg.cn/large/006tNc79ly1fpusaq5hm5j30rs01l0up.jpg">
<meta property="og:image" content="https://ws2.sinaimg.cn/large/006tNc79ly1fpusdjl9loj30iq00qaaa.jpg">
<meta property="og:image" content="https://ws3.sinaimg.cn/large/006tNc79ly1fpusfb8d48j308c0etjsh.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/006tNc79ly1fpusgaa5ixj30rs082tl8.jpg">
<meta property="og:updated_time" content="2018-03-30T06:32:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="由Dialog里面嵌套ListView之后的高度自适应引起的ListView性能优化">
<meta name="twitter:description" content="先说ListView给高的正确做法.android:layout_height属性：  必须将ListView的布局高度属性设置为非“wrap_content”（可以是“match_parent /  fill_parent  /  400dp等绝对数值”）">
<meta name="twitter:image" content="https://dn-coding-net-production-pp.qbox.me/db684e69-16b3-41af-bd42-fd92506790ce.png">
  
    <link rel="alternate" href="/atom.xml" title="独ǒ无②&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">独ǒ无②&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">独ǒ无② 的技术小黑屋</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.shenzhenwei.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-20180330AndroidListViewInDialog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/30/20180330AndroidListViewInDialog/" class="article-date">
  <time datetime="2018-03-30T05:15:37.000Z" itemprop="datePublished">2018-03-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android开发笔记/">Android开发笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      由Dialog里面嵌套ListView之后的高度自适应引起的ListView性能优化
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先说ListView给高的正确做法.<br><strong>android:layout_height属性：</strong></p>
<blockquote>
<p>必须将ListView的布局高度属性设置为非“wrap_content”（可以是“match_parent /  fill_parent  /  400dp等绝对数值”）</p>
</blockquote>
<a id="more"></a>
<p>废话少说先来张bug图填楼</p>
<p><img src="https://dn-coding-net-production-pp.qbox.me/db684e69-16b3-41af-bd42-fd92506790ce.png" alt="图片"><br><!--more--></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>随着RecyclerView的普及,ListView差不多是安卓快要淘汰的控件了,但是我们有时候还是会用到,基本上可以说是前些年最常用的Android控件之一了.抛开我们的主题,我们先来谈谈ListView的一些小小的细节,可能是很多开发者在开发过程中并没有注意到的细节,这些细节设置会影响到我们的App的性能.</p>
<ul>
<li><strong>android:layout_height属性</strong></li>
</ul>
<p>我们在使用ListView的时候很可能随手就会写一个<code>layout_height=”wrap_content”</code>或者<code>layout_height=”match_parent”</code>,非常非常普通,咋一看,我写的没错啊…可是实际上<code>layout_height=”wrap_content”</code> <strong>是错误的写法!!!会严重影响程序的性能</strong> 我们先来做一个实验:<br>xml布局文件如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ListView</span><br><span class="line">        android:id=&quot;@+id/list_view&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        &gt;&lt;/ListView&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>java部分代码<br><img src="https://dn-coding-net-production-pp.qbox.me/917604eb-c83f-468f-a509-e1adcea53472.png" alt="图片"></p>
<p>运行log<br><img src="https://dn-coding-net-production-pp.qbox.me/19b0ceaa-ffd6-44d6-80a1-3d4034e5ead5.png" alt="图片"></p>
<p>我们会发现getView总共被调用了15次!其中4次是null的,11次为重复调用,ListView的item数目只有3项!!!<strong>太可怕了</strong></p>
<p>我们试着将ListView的高度属性改为<code>layout_height=”match_parent”</code>,然后看看<br><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fpusaq5hm5j30rs01l0up.jpg" alt=""><br>我们可以看到<code>getView()</code>只被调用了3次!这应该是我们期望的结果!</p>
<p><strong>原因分析:</strong><br>了解原因前,我们应该先了解View的绘制流程,之前我的博客没有关于View绘制流程的介绍,那么在这边说一下,是一个很重要的知识点.<br>View的绘制流程是通过 <code>onMeasure()</code>-&gt;<code>onLayout()</code>-&gt;<code>onDraw()</code></p>
<p><code>onMeasure()</code> :主要工作是测量视图的大小.从顶层的父View到子View递归调用measure方法,measure方法又回调onMeasure().</p>
<p><code>onLayout</code>: 主要工作是确定View的位置,进行页面布局.从顶层的父View向子View的递归调用view.layout方法的过程,即父View根据上一步measure子view所得到的布局大小和布局参数,将子view放在合适的位置上</p>
<p><code>onDraw()</code> 主要工作是绘制视图.ViewRoot创建一个Canvas对象,然后调用onDraw()方法.总共6个步骤.1.绘制视图背景,2.保存当前画布的图层(Layer),3.绘制View内容,4.绘制View的子View视图,没有的话就不绘制,5.还原图层,6.绘制滚动条.</p>
<p>了解了View的绘制流程,那么我们回到这个问题上.设置ListView的属性<code>layout_height=”wrap_content”</code>,就意味着Listview的高度由子View决定,当在onMeasure()的时候,需要测量子View的高度,那我们来看看Listview的onMeasure()方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Sets up mListPadding</span></span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> childWidth = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> childHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> childState = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        mItemCount = mAdapter == <span class="keyword">null</span> ? <span class="number">0</span> : mAdapter.getCount();</span><br><span class="line">        <span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span> &amp;&amp; (widthMode == MeasureSpec.UNSPECIFIED ||</span><br><span class="line">                heightMode == MeasureSpec.UNSPECIFIED)) &#123;</span><br><span class="line">            <span class="keyword">final</span> View child = obtainView(<span class="number">0</span>, mIsScrap);</span><br><span class="line"></span><br><span class="line">            measureScrapChild(child, <span class="number">0</span>, widthMeasureSpec);</span><br><span class="line"></span><br><span class="line">            childWidth = child.getMeasuredWidth();</span><br><span class="line">            childHeight = child.getMeasuredHeight();</span><br><span class="line">            childState = combineMeasuredStates(childState, child.getMeasuredState());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (recycleOnMeasure() &amp;&amp; mRecycler.shouldRecycleViewType(</span><br><span class="line">                    ((LayoutParams) child.getLayoutParams()).viewType)) &#123;</span><br><span class="line">                mRecycler.addScrapView(child, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (widthMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">            widthSize = mListPadding.left + mListPadding.right + childWidth +</span><br><span class="line">                    getVerticalScrollbarWidth();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            widthSize |= (childState&amp;MEASURED_STATE_MASK);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (heightMode == MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">            heightSize = mListPadding.top + mListPadding.bottom + childHeight +</span><br><span class="line">                    getVerticalFadingEdgeLength() * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> after first layout we should maybe start at the first visible position, not 0</span></span><br><span class="line">            heightSize = measureHeightOfChildren(widthMeasureSpec, <span class="number">0</span>, NO_POSITION, heightSize, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setMeasuredDimension(widthSize , heightSize);</span><br><span class="line">        mWidthMeasureSpec = widthMeasureSpec;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">            // TODO: after first layout we should maybe start at the first visible position, not 0</span><br><span class="line">            heightSize = measureHeightOfChildren(widthMeasureSpec, 0, NO_POSITION, heightSize, -1);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>比较重要</p>
<p>再看<code>measureHeightOfChildren()</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">final int measureHeightOfChildren(int widthMeasureSpec, int startPosition, int endPosition,</span><br><span class="line">            final int maxHeight, int disallowPartialChildPosition) &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        for (i = startPosition; i &lt;= endPosition; ++i) &#123;</span><br><span class="line">            child = obtainView(i, isScrap);</span><br><span class="line"></span><br><span class="line">            measureScrapChild(child, i, widthMeasureSpec);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            // Recycle the view before we possibly return from the method</span><br><span class="line">            if (recyle &amp;&amp; recycleBin.shouldRecycleViewType(</span><br><span class="line">                    ((LayoutParams) child.getLayoutParams()).viewType)) &#123;</span><br><span class="line">                recycleBin.addScrapView(child, -1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            returnedHeight += child.getMeasuredHeight();</span><br><span class="line"></span><br><span class="line">            if (returnedHeight &gt;= maxHeight) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if ((disallowPartialChildPosition &gt;= 0) &amp;&amp; (i &gt;= disallowPartialChildPosition)) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return returnedHeight;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>obtainView(i, isScrap)</code>是子View的实例<br><code>measureScrapChild(child, i, widthMeasureSpec);</code> 测量子View<br><code>recycleBin.addScrapView(child, -1);</code>将子View加入缓存,可以用来复用<br><code>if (returnedHeight &gt;= maxHeight) {return ...;}</code>如果已经测量的子View的高度大于maxHeight的话就直接return出循环,这样的做法也很好理解,其实是ListView很聪明的一种做法,你可以想想比如说这个屏幕只能画10个Item高度,你有20个Item,那么画出10个就行了,剩下的十个就没必要画了~</p>
<p>我们现在看下<code>obtainView()</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">View obtainView(int position, boolean[] isScrap) &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;obtainView&quot;);</span><br><span class="line"></span><br><span class="line">        isScrap[0] = false;</span><br><span class="line"></span><br><span class="line">        // Check whether we have a transient state view. Attempt to re-bind the</span><br><span class="line">        // data and discard the view if we fail.</span><br><span class="line">        final View transientView = mRecycler.getTransientStateView(position);</span><br><span class="line">        if (transientView != null) &#123;</span><br><span class="line">            final LayoutParams params = (LayoutParams) transientView.getLayoutParams();</span><br><span class="line"></span><br><span class="line">            // If the view type hasn&apos;t changed, attempt to re-bind the data.</span><br><span class="line">            if (params.viewType == mAdapter.getItemViewType(position)) &#123;</span><br><span class="line">                final View updatedView = mAdapter.getView(position, transientView, this);</span><br><span class="line"></span><br><span class="line">                // If we failed to re-bind the data, scrap the obtained view.</span><br><span class="line">                if (updatedView != transientView) &#123;</span><br><span class="line">                    setItemViewLayoutParams(updatedView, position);</span><br><span class="line">                    mRecycler.addScrapView(updatedView, position);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Scrap view implies temporary detachment.</span><br><span class="line">            isScrap[0] = true;</span><br><span class="line">            return transientView;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final View scrapView = mRecycler.getScrapView(position);</span><br><span class="line">        final View child = mAdapter.getView(position, scrapView, this);</span><br><span class="line">        if (scrapView != null) &#123;</span><br><span class="line">            if (child != scrapView) &#123;</span><br><span class="line">                // Failed to re-bind the data, return scrap to the heap.</span><br><span class="line">                mRecycler.addScrapView(scrapView, position);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                isScrap[0] = true;</span><br><span class="line"></span><br><span class="line">                child.dispatchFinishTemporaryDetach();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (mCacheColorHint != 0) &#123;</span><br><span class="line">            child.setDrawingCacheBackgroundColor(mCacheColorHint);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (child.getImportantForAccessibility() == IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</span><br><span class="line">            child.setImportantForAccessibility(IMPORTANT_FOR_ACCESSIBILITY_YES);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setItemViewLayoutParams(child, position);</span><br><span class="line"></span><br><span class="line">        if (AccessibilityManager.getInstance(mContext).isEnabled()) &#123;</span><br><span class="line">            if (mAccessibilityDelegate == null) &#123;</span><br><span class="line">                mAccessibilityDelegate = new ListItemAccessibilityDelegate();</span><br><span class="line">            &#125;</span><br><span class="line">            if (child.getAccessibilityDelegate() == null) &#123;</span><br><span class="line">                child.setAccessibilityDelegate(mAccessibilityDelegate);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line"></span><br><span class="line">        return child;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>得到一个视图,它显示的数据与指定的位置。这叫做当我们已经发现的观点不是可供重用的回收站。剩下的唯一的选择是将一个古老的视图或制作一个新的.(这是方法注释的翻译,大致可以理解他的意思)</p>
<p>我们应该关注下以下两行代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  final View scrapView = mRecycler.getScrapView(position);</span><br><span class="line">  final View child = mAdapter.getView(position, scrapView, this);</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>这两行代码的意思就是说先从缓存里面取出来一个废弃的view,然后将当前的位置跟view作为参数传入到getView()方法中.这个废弃的,然后又作为参数的view就是convertView.</p>
<p>然后我们总结下刚刚的步骤:<br>A、测量第0项的时候，convertView肯定是null的 View scrapView = mRecycler.getScrapView(position)也是空的,所以我们在log上可以看到.<br><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fpusdjl9loj30iq00qaaa.jpg" alt=""><br>B、第0项测量结束,这个第0项的View就被加入到复用缓存当中了；<br>C、开始测量第1项，这时因为是有第0项的View缓存的，所以getView的参数convertView就是这个第0项的View缓存，然后重复B步骤添加到缓存，只不过这个View缓存还是第0项的View；<br>D、继续测量第2项，重复C。</p>
<p>所以前面说到onMeasure方法会导致getView调用，而一个View的onMeasure方法调用时机并不是由自身决定，而是由其父视图来决定。ListView放在FrameLayout和RelativeLayout中其onMeasure方法的调用次数是完全不同的。在RelativeLayout中oMeasure()方法调用会翻倍.</p>
<p>由于onMeasure方法会多次被调用，上述问题中是两次，其实完整的调用顺序是onMeasure - onLayout - onMeasure - onLayout - onDraw。</p>
<p>所以根据上面的结论我们可以得出,如果LitsView的<strong>android:layout_height属性设置为wrap_content</strong>将会引起<code>getView的多次测量</code></p>
<h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p>如上bug图…</p>
<h1 id="产生的原因"><a href="#产生的原因" class="headerlink" title="产生的原因"></a>产生的原因</h1><ul>
<li><p>ListView的高度设置成了android:layout_height属性设置为wrap_content</p>
</li>
<li><p>ListView的父类是RelativeLayout,RelativiLayout布局会使子布局View的Measure周期翻倍,有兴趣可以看下<a href="http://blog.csdn.net/megatronkings/article/details/52270461" target="_blank" rel="noopener">三大基础布局性能比较</a></p>
</li>
</ul>
<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>根据每个Item的高度,然后再根据Adapter的count来动态算高.<br>代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class SetHeight &#123;</span><br><span class="line"></span><br><span class="line">    public void setListViewHeightBasedOnChildren(ListView listView, android.widget.BaseAdapter adapter) &#123;</span><br><span class="line"></span><br><span class="line">        if (adapter==null)&#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        int totalHeight = 0;</span><br><span class="line"></span><br><span class="line">        for (int i = 0; i &lt; adapter.getCount(); i++) &#123; // listAdapter.getCount()返回数据项的数目</span><br><span class="line"></span><br><span class="line">            View listItem = adapter.getView(i, null, listView);</span><br><span class="line"></span><br><span class="line">            listItem.measure(0, 0); // 计算子项View 的宽高</span><br><span class="line"></span><br><span class="line">            totalHeight += listItem.getMeasuredHeight(); // 统计所有子项的总高度</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ViewGroup.LayoutParams params = listView.getLayoutParams();</span><br><span class="line"></span><br><span class="line">        params.height = totalHeight</span><br><span class="line">                + (listView.getDividerHeight() * (adapter.getCount() - 1));</span><br><span class="line"></span><br><span class="line">        // listView.getDividerHeight()获取子项间分隔符占用的高度</span><br><span class="line"></span><br><span class="line">        // params.height最后得到整个ListView完整显示需要的高度</span><br><span class="line"></span><br><span class="line">        listView.setLayoutParams(params);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>xml布局,<strong>注意要将ListView的父类设置为LinearLayout</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;LinearLayout</span><br><span class="line">        android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_above=&quot;@+id/txt_cancel&quot;</span><br><span class="line">        android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line">        &lt;View</span><br><span class="line">            android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">            android:layout_height=&quot;@dimen/y2&quot;</span><br><span class="line">            android:background=&quot;#cccccc&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;ListView</span><br><span class="line">            android:id=&quot;@+id/lv_remain_item&quot;</span><br><span class="line">            android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">            android:layout_height=&quot;0dp&quot;</span><br><span class="line">            android:cacheColorHint=&quot;#00000000&quot;</span><br><span class="line">            &gt;&lt;/ListView&gt;</span><br><span class="line"></span><br><span class="line">        &lt;View</span><br><span class="line">            android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">            android:layout_height=&quot;@dimen/y2&quot;</span><br><span class="line">            android:background=&quot;#cccccc&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/LinearLayout&gt;</span><br><span class="line"></span><br><span class="line">    &lt;LinearLayout</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:gravity=&quot;center&quot;</span><br><span class="line">        android:orientation=&quot;horizontal&quot;</span><br><span class="line">        &gt;</span><br><span class="line"></span><br><span class="line">        &lt;TextView</span><br><span class="line">            android:id=&quot;@+id/txt_cancel&quot;</span><br><span class="line">            android:layout_width=&quot;fill_parent&quot;</span><br><span class="line">            android:layout_height=&quot;@dimen/y120&quot;</span><br><span class="line">            android:layout_alignParentBottom=&quot;true&quot;</span><br><span class="line">            android:gravity=&quot;center&quot;</span><br><span class="line">            android:text=&quot;cancel&quot;</span><br><span class="line">            android:textSize=&quot;@dimen/x32&quot; /&gt;</span><br><span class="line">    &lt;/LinearLayout&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后在Listview使用处,调用该方法.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userListDialog.getmListView().setAdapter(scaleUserAdapter);</span><br><span class="line">SetHeight.setListViewHeightBasedOnChildren(userListDialog.getmListView(),scaleUserAdapter);</span><br></pre></td></tr></table></figure></p>
<h1 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h1><p><img src="https://ws3.sinaimg.cn/large/006tNc79ly1fpusfb8d48j308c0etjsh.jpg" alt=""></p>
<p>getView()调用情况<br><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fpusgaa5ixj30rs082tl8.jpg" alt=""><br>GitHub代码地址:<a href="https://github.com/pvphero/ListViewDialog" target="_blank" rel="noopener">ListViewDialog</a>,喜欢的话欢迎Start</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.shenzhenwei.cn/2018/03/30/20180330AndroidListViewInDialog/" data-id="cjjjbhfex0004zw4pm6hge1tx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ListView/">ListView</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/性能优化/">性能优化</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/04/03/20180403StopWorld/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          StopWorld组织成立
        
      </div>
    </a>
  
  
    <a href="/2018/03/13/20180313AndroidInterViewFragment/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Fragment生命周期</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AndroidInterview/">AndroidInterview</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发笔记/">Android开发笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-Studio/">Android Studio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bitmap/">Bitmap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/">Blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coding/">Coding</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debug/">Debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/">GitHub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Intent/">Intent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Interview/">Interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ListView/">ListView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/">Mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NDK/">NDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UI/">UI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fragment/">fragment</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/setFlags/">setFlags</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能优化/">性能优化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Android-Studio/" style="font-size: 10px;">Android Studio</a> <a href="/tags/Bitmap/" style="font-size: 10px;">Bitmap</a> <a href="/tags/Blog/" style="font-size: 10px;">Blog</a> <a href="/tags/Coding/" style="font-size: 10px;">Coding</a> <a href="/tags/Debug/" style="font-size: 10px;">Debug</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Intent/" style="font-size: 10px;">Intent</a> <a href="/tags/Interview/" style="font-size: 10px;">Interview</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/ListView/" style="font-size: 15px;">ListView</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/NDK/" style="font-size: 15px;">NDK</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/fragment/" style="font-size: 15px;">fragment</a> <a href="/tags/setFlags/" style="font-size: 10px;">setFlags</a> <a href="/tags/性能优化/" style="font-size: 10px;">性能优化</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/07/04/20180704AndroidUseDrawerLayout/">Android使用ToolBar+DrawerLayout+NavigationView实现侧滑抽屉效果</a>
          </li>
        
          <li>
            <a href="/2018/04/13/20180413UseWifiToDebugApp/">AndroidStudio利用ADB WIFI调试程序</a>
          </li>
        
          <li>
            <a href="/2018/04/03/20180403StopWorld/">StopWorld组织成立</a>
          </li>
        
          <li>
            <a href="/2018/03/30/20180330AndroidListViewInDialog/">由Dialog里面嵌套ListView之后的高度自适应引起的ListView性能优化</a>
          </li>
        
          <li>
            <a href="/2018/03/13/20180313AndroidInterViewFragment/">Fragment生命周期</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 独ǒ无②<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>